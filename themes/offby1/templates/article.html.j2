{% extends "base.html.j2" %}

{% block title %}{{ article.title }} - {{ SITENAME }}{% endblock %}
{% block description %}{{ (article.summary or article.content) | striptags | e | truncate(160) }}{% endblock %}

{% block og_title %}{{ article.title }}{% endblock %}
{% block og_description %}{{ (article.summary or article.content) | striptags | e | truncate(160) }}{% endblock %}
{% block og_url %}{{ SITEURL }}/{{ article.url }}{% endblock %}

{% block og_image %}
{% if article.social_image %}
<meta property="og:image" content="{{ SITEURL }}{{ article.social_image }}" />
<meta property="og:image:alt" content="{{ article.title }}" />
{% endif %}
{% endblock %}

{% block twitter_image %}
{% if article.social_image %}
<meta name="twitter:image" content="{{ SITEURL }}{{ article.social_image }}" />
<meta name="twitter:image:alt" content="{{ article.title }}" />
{% endif %}
{% endblock %}

{% block extra_head %}
{% if article.toot is defined %}
{# Load federated comments scripts #}
{% assets output="js/purify.js", "purify.min.js" %}
<script src="{{SITEURL}}/{{ASSET_URL}}"></script>
{% endassets %}
<script src="{{ SITEURL }}/js/federated-comments.js"></script>
{% endif %}
{% endblock %}

{% block body_class %}single-article{% endblock %}

{% block content %}
<article>
    <header>
        <h1>{{ article.title }}</h1>
        <div class="article-meta">
            <time datetime="{{ article.date.isoformat() }}">{{ article.locale_date }}</time>
            {% if article.modified %}
            <span class="separator">路</span>
            <span>Updated: <time datetime="{{ article.modified.isoformat() }}">{{ article.modified.strftime('%B %d, %Y') }}</time></span>
            {% endif %}
            {% if article.category %}
            <span class="separator">路</span>
            <a href="{{ SITEURL }}/{{ article.category.url }}">{{ article.category }}</a>
            {% endif %}
            {% if article.author %}
            <span class="separator">路</span>
            <span>{{ article.author }}</span>
            {% endif %}
        </div>
    </header>
    
    {% if PUBLICATION_TIME.year - article.date.year > 5 %}
    <div class="admonition historical">
        <p class="admonition-title">Historical Post</p>
        <p>
            Hi, reader. I wrote this in {{ article.date.year }}. Technology and culture
            referenced may have changed and I nearly certainly have. I may disagree now
            with what I wrote then, or it may refer to obsolete terms and tech. I will
            usually only edit old posts to refresh links that have changed. If this post
            is particularly offensive please <a href="/about.html">contact me</a> and
            let me know.</p>
    </div>
    {% endif %}
    
    <div class="article-content">
        {{ article.content }}
    </div>
    
    {% if article.photo_gallery %}
    <div class="photo-gallery">
        {% for title, gallery in article.photo_gallery %}
        <h2>{{ title }}</h2>
        <div class="gallery-grid">
            {% for name, photo, thumb, exif, caption in gallery %}
            <a href="{{ SITEURL }}/{{ photo }}" 
               class="gallery-item" 
               title="{{ name }}"{% if exif %}
               data-exif="{{ exif }}"{% endif %}{% if caption %}
               data-caption="{{ caption }}"{% endif %}>
                <img src="{{ SITEURL }}/{{ thumb }}" alt="{{ caption or name }}" loading="lazy">
                {% if caption %}
                <div class="gallery-caption">{{ caption }}</div>
                {% endif %}
            </a>
            {% endfor %}
        </div>
        {% endfor %}
    </div>
    {% endif %}
    
    {% if article.tags %}
    <footer>
        <div class="article-tags">
            {% for tag in article.tags %}
            <a href="{{ SITEURL }}/{{ tag.url }}" class="tag">{{ tag }}</a>
            {% endfor %}
        </div>
    </footer>
    {% endif %}
    
    {# Feedback section #}
    <div class="article-feedback">
        {% if article.has_feedback %}
            <h3>Feedback</h3>
            {% if article.lobsters %}
                <p>Discuss this post on <a href="{{ article.lobsters }}">lobste.rs</a>.</p>
            {% endif %}
            {% if article.toot %}
                {% set toot = article.toot %}
                {% include "federated_comments.html.j2" %}
            {% endif %}
        {% else %}
            <div class="no-comments">
                <h3>Feedback</h3>
                <p>I don't embed any comments on this site, so if you want
                to give me feedback on the posts you find here, I encourage
                you tag me on <span class="fa-brands fa-mastodon"></span> <a class="sc-mastodon" href="https://wandering.shop/@offby1">wandering.shop</a></p>
            </div>
        {% endif %}
    </div>
    
    {# Similar Posts Section #}
    {% if article.similar_posts %}
    <section class="related-posts-section">
        <h3 class="recent-posts-heading">Similar Posts</h3>
        
        <div class="recent-posts-grid">
            {% for similar in article.similar_posts[:4] %}
            <article class="post-card">
                <h4><a href="{{ SITEURL }}/{{ similar.url }}">{{ similar.title }}</a></h4>
                <div class="meta">
                    <time datetime="{{ similar.date.isoformat() }}">{{ similar.locale_date }}</time>
                    {% if similar.category %} 路 {{ similar.category }}{% endif %}
                </div>
                {% if similar.summary %}
                <p class="excerpt">{{ similar.summary | striptags | truncate(150) }}</p>
                {% else %}
                <p class="excerpt">{{ similar.content | striptags | truncate(150) }}</p>
                {% endif %}
                {% if similar.tags %}
                <div class="tags">
                    {% for tag in similar.tags[:3] %}
                    <a href="{{ SITEURL }}/{{ tag.url }}" class="tag">{{ tag }}</a>
                    {% endfor %}
                </div>
                {% endif %}
            </article>
            {% endfor %}
        </div>
    </section>
    {% endif %}
</article>
{% endblock %}
